require 'rubygems'
require 'json'
$LOAD_PATH << 'lib/'
require 'driverSQLITE'
require 'mongo'
include Mongo

@connect = MongoClient.new("localhost",27017) 

@db = @connect.db('paye2')
t_fetch =  @db['entites'].find({ '_type' => 'fetch' },{:fields => {'jcl' => 1, 'nom' => 1,'appli' => 1, 'sid' => 1}}).to_a
h_fetch={}
t_fetch.each do |i|
    h_fetch[i['sid']]  = [i['appli'],i['jcl'],i['nom']]
end
Texec.all.each do |t| 
    cle = t.step_id
    monstep = Tstep.all(:id =>cle).to_a
    mon_id_fetch = monstep[0].fetch_id

    my_h = {:sid => t.id,
            :fetch_id =>   mon_id_fetch,        
            :appli    => h_fetch[mon_id_fetch][0],
            :jcl      => h_fetch[mon_id_fetch][1],                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
            :fetch    => h_fetch[mon_id_fetch][2],
            :step => monstep[0].nom,
            :pgm => t.pgm,
            :_type       => 'exec'
    }
            my_h[:fonction] = t.fonction  if t.fonction
            my_h[:information] = t.information if t.information
 
    puts my_h
    res = @db['entites'].insert(my_h)
end
